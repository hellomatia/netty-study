# 채널 파이프라인과 코덱

[자바 네트워크 소녀 Netty](https://product.kyobobook.co.kr/detail/S000001057642)

채널 파이프라인은 채널에서 발생한 이벤트가 이동하는 통로이다. 해당 통로를 통해서 이동하는 이벤트를 처리하는 클래스를 이벤트 핸들러라 한다.

이벤트 핸들러를 상속받아 구현한 구현체들이 코덱이라 한다.

자주 사용하는 이벤트 핸들러들을 미리 구현한 곳이 `io.netty.handler.codec`패키지에 있다.

### 이벤트 실행

네티의 이벤트 메서드는 데이터가 수신되면 **자동**으로 호출된다.

네티 없이 일반 서버 네트워크는 아래와 같은 로직으로 작성해야 할 것이다.
```
1. 소켓에 데이터가 있는지 확인
2. 데이터가 존재하면 데이터를 읽어들이는 메서드를 실행
3. 일어들일 데이터가 존재하지 않는다면 데이터가 도착할 때까지 기다림
4. 데이터를 기다리는 중에 네트워크가 끊어지만 에러 처리를 위한 메서드 호출
```

예외에 대한 대비가 철저할수록 오류는 적어지지만 프로그램 복잡도는 증가한다.

네티를 사용하면 데이터가 수신되었는지, 소켓의 연결이 끊어졌는지와 같은 예외 상태에서 메서드 호출에 관여할 필요가 없다.

네티로 작성하면 아래와 같다.
```
1. 부트스트랩으로 네트워크 애플리케이션에 필요한 설정을 지정한다.
2. 부트스트랩에 이벤트 핸들러를 사용하여 채널 파이프라인을 구성한다.
3. 이벤트 핸들러의 데이터 수신 이벤트 메서드에서 데이터를 읽어들인다.
4. 이벤트 핸들러의 네트워크 끊김 이벤트 메서드에서 에러 처리를 한다.
```

위와 같이 구현하면 네티의 이벤트 루프가 소켓 채널에서 발생한 이벤트에 해당하는 이벤트 메서드를 자동으로 실행한다.

소켓 채널에 데이터가 수신되었을 때, 네티가 이벤트 메서드를 실행하는 방법은 아래와 같다.
```
1. 네티의 이벤트 루프가 채널 파이프라인에 등록된 첫 번째 이벤트를 가져온다.
2. 이벤트 핸들러에 데이터 수신 이벤트 메서드가 구현되어 있으면 실행한다.
3. 데이터 수신 이벤트 메서드가 구현되어 있지 않으면 다음 이벤트 핸들러를 가져온다.
4. 2를 수행한다.
5. 채널 파이프라인에 등록된 마지막 이벤트 핸들러에 도달할 때까지 1을 반복한다.
```

### 채널 파이프라인

채널 파이프라인은 네티의 채널과 이벤트 핸들러 사이에서 연결 통로 역할을 수행한다.

채널은 일반적으로 소켓 프로그래밍에서 말하는 소켓과 같다고 생각하면 된다. 네티는 이벤트 처리를 위한 추상화 모델로서 채널 파이프라인을 사용하는데 소켓 채널에서 발생한 이벤트가 이를 통로로 하여 이동한다.

### 이벤트 핸들러 
네티는 비동기 호출을 지원하는 두 가지 패턴을 제공한다. 하나는 퓨처 패턴, 다른 하나는 리엑터 패턴의 구현체인 이벤트 핸들러이다. 

조금 더 자세히 설명하면 소켓 채널에서 발생한 이벤트를 처리하는 인터페이스이다. 

**채널 인바운드 이벤트**
네티는 소켓 채널에서 발생한 이벤트를 인바운드 이벤트, 아웃바운드 이벤트로 추상화 한다. 

**아웃바운드 이벤트**
아웃바운드 이벤트는 소켓 채널에서 발생한 이벤트 중에서 네티 사용자가 요청한 동작에 해당하는 이벤트를 말하며 요청, 데이터 전송, 소켓 닫기 등이 이에 해당한다. 

### 코덱
보통 동영상 압축 알고리즘을 코덱이라 부른다.

영상 파일을 압축했으니 원본으로 만들어서 시청하려면 압축 해제를 해야한다. 

이 과정을 네티의 소켓 채널로 옮겨지만 인코더는 아웃 바운드, 디코더는 인바운드가 된다. 

네티에서는 인코더는 전송할 데이터를 전송 프로토콜에 맞추어 변환 작업을 수행하고 디코더는 반대의 작업을 수행한다.

### 코덱의 구조
동영상 코덱과 달리 인코딩과 디코딩 대상이 애플리케이션 내부의 데이터이다. 데이터를 전송할 때에는 인코더를 사용하여 패킷으로 변환하고, 디코더를 사용하여 패킷을 다시 데이터로 변환한다.